<!doctype html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plan een afspraak</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 700px; }
        .card { border-radius: 0.75rem; }
        .slot-picker { height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 0.5rem; }
        .slot-picker .btn { width: 100%; margin-bottom: 0.5rem; border-width: 2px; }
        .slot-picker .btn.verifying .spinner-border { width: 1rem; height: 1rem; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card shadow-sm">
            <div class="card-body p-5">
                <div id="address-view">
                    <h1 id="appointment-title-main" class="card-title text-center mb-4">üóìÔ∏è Plan uw afspraak</h1>
                    <p id="appointment-description" class="text-center"></p>
                    <p class="text-center text-muted mb-4">Voer uw adres in om de reistijd te berekenen en beschikbare tijden te zien.</p>
                    <div class="mb-3">
                        <label for="destinationAddress" class="form-label fs-5">Uw afspraakadres</label>
                        <input type="text" class="form-control form-control-lg" id="destinationAddress" placeholder="Begin met typen..." required />
                    </div>
                    <div class="d-grid">
                        <button id="check-availability-btn" class="btn btn-primary btn-lg">Toon beschikbare tijden</button>
                    </div>
                </div>

                <div id="loading-view" style="display: none" class="text-center">
                    <div class="spinner-border" role="status"><span class="visually-hidden">Laden...</span></div>
                    <p class="mt-3">Beschikbaarheid wordt berekend...</p>
                </div>

                <div id="booking-view" style="display: none">
                    <h2 id="appointment-title-booking" class="text-center mb-4"></h2>
                    <p class="text-center text-muted mb-4">Kies een dag en een tijdstip. Klik op een tijd om de reistijd te controleren.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <h3 class="fs-5 text-center mb-3">Kies een dag ‚òÄÔ∏è</h3>
                            <div id="day-picker" class="slot-picker"></div>
                        </div>
                        <div class="col-md-6">
                            <h3 class="fs-5 text-center mb-3">Kies een tijd ‚è∞</h3>
                            <div id="time-picker" class="slot-picker"></div>
                        </div>
                    </div>
                    
                    <div id="legend" class="mt-4 p-3 bg-light border rounded" style="display: none;">
                        <h4 class="fs-6 mb-3">Uitleg kleuren</h4>
                        <ul class="list-unstyled mb-0"></ul>
                    </div>

                    <div id="diagnostic-panel" class="mt-4" style="display: none;">
                        <h4 class="fs-6">ü§ñ Reistijdrekenmachine</h4>
                        <div class="table-responsive" style="max-height: 200px;">
                            <table class="table table-sm table-bordered">
                                <thead><tr><th>Van</th><th>Naar</th><th>Status</th><th>Reistijd</th></tr></thead>
                                <tbody id="diagnostic-table-body"></tbody>
                            </table>
                            <p class="text-muted small mt-2">Reistijd is een schatting bij normale verkeersdrukte.</p>
                            <p id="total-time-info" class="fw-bold"></p>
                        </div>
                    </div>

                    <form id="booking-form" style="display: none" class="mt-4">
                        <h3 id="booking-form-title" class="fs-5 mb-3">Bevestig uw gegevens</h3>
                        <div class="mb-3"><label for="name" class="form-label">Uw naam</label><input type="text" id="name" class="form-control" required /></div>
                        <div class="mb-3"><label for="email" class="form-label">Uw e-mailadres</label><input type="email" id="email" class="form-control" required /></div>
                        <div class="mb-3"><label for="phone" class="form-label">Uw telefoonnummer</label><input type="tel" id="phone" class="form-control" required /></div>
                        <div class="mb-3"><label for="comments" class="form-label">Opmerkingen (optioneel)</label><textarea id="comments" class="form-control" rows="3"></textarea></div>
                        <div class="d-grid"><button type="submit" class="btn btn-success btn-lg">‚úÖ Afspraak bevestigen</button></div>
                    </form>
                </div>

                <div id="confirmation-view" style="display: none" class="text-center">
                    <h2 class="text-success mb-3">üéâ Afspraak bevestigd!</h2>
                    <p>U ontvangt een bevestiging per e-mail met de details van uw afspraak.</p>
                </div>

                <div id="error-view" style="display: none" class="text-center">
                    <h2 class="text-danger mb-3">Er is iets misgegaan</h2>
                    <p id="error-message"></p>
                    <button class="btn btn-primary" onclick="location.reload()">Probeer opnieuw</button>
                </div>
            </div>
        </div>
    </div>

    <footer class='text-center mt-5 p-4 text-muted border-top'><a href='/privacy.html'>Privacybeleid</a></footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const linkId = params.get('linkId');
        let selectedSlot = null;
        let slotsByDay = new Map();
        let rippledDays = new Set();
        let destinationAddress = '';
        let appointmentDuration = 0;
        let creatorEmail = '';
        let appointmentTitle = '';

        const marginClassMap = {
            blue: 'border-primary',
            yellow: 'border-warning',
            red: 'border-danger'
        };

        const certaintyInfo = {
            green:  { class: 'btn-success', borderClass: 'border-success', text: 'Reistijd is berekend. Deze afspraak is bevestigd.' },
            blue:   { class: 'btn-outline-primary', borderClass: 'border-primary', text: 'Ruime marge (>1 uur) tot de volgende afspraak.' },
            yellow: { class: 'btn-outline-primary', borderClass: 'border-warning', text: 'Beperkte marge (30-60 min) tot de volgende afspraak.' },
            red:    { class: 'btn-outline-primary', borderClass: 'border-danger',  text: 'Weinig marge (<30 min) tot de volgende afspraak.' },
        };

        function switchView(viewId) {
            ['address-view', 'loading-view', 'booking-view', 'confirmation-view', 'error-view'].forEach(id => {
                document.getElementById(id).style.display = id === viewId ? 'block' : 'none';
            });
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            switchView('error-view');
        }

        function displayLegend() {
            const legendContainer = document.querySelector('#legend ul');
            legendContainer.innerHTML = '';
            ['green', 'blue', 'yellow', 'red'].forEach(key => {
                const info = certaintyInfo[key];
                const li = document.createElement('li');
                li.className = 'mb-2 d-flex align-items-center';
                const color = info.class.includes('success') ? `var(--bs-success)` : `var(--bs-${info.borderClass.split('-')[1]})`;
                const borderStyle = info.class.includes('success') ? '' : `border: 2px solid ${color}; background-color: transparent;`;
                const bgStyle = info.class.includes('success') ? `background-color: ${color};` : '';
                li.innerHTML = `<span style="height: 15px; width: 15px; ${bgStyle} ${borderStyle} border-radius: 50%; display: inline-block; margin-right: 10px; flex-shrink: 0;"></span><div><small>${info.text}</small></div>`;
                legendContainer.appendChild(li);
            });
            document.getElementById('legend').style.display = 'block';
        }

        function formatDuration(seconds) {
            if (seconds === null || seconds === undefined) return 'N/A';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.round((seconds % 3600) / 60);
            let result = '';
            if (hours > 0) result += `${hours} uur `;
            if (minutes > 0 || hours === 0) result += `${minutes} min`;
            return result.trim();
        }

        function updateDiagnostics(diagnosticLog) {
            const diagnosticTableBody = document.getElementById('diagnostic-table-body');
            diagnosticTableBody.innerHTML = '';
            if (!diagnosticLog || diagnosticLog.length === 0) {
                 document.getElementById('diagnostic-panel').style.display = 'none';
                return;
            }
            
            let totalTravelSeconds = 0;
            diagnosticLog.forEach(log => {
                const row = diagnosticTableBody.insertRow();
                row.insertCell().textContent = log.originAddress || 'Onbekend';
                row.insertCell().textContent = log.destinationAddress || 'Onbekend';
                const statusCell = row.insertCell();
                statusCell.textContent = log.status;
                statusCell.style.fontWeight = 'bold';
                statusCell.style.color = log.status === 'OK' ? 'green' : 'red';
                row.insertCell().textContent = formatDuration(log.duration);
                if (log.status === 'OK') {
                    totalTravelSeconds += log.duration;
                }
            });

            const totalDurationSeconds = (appointmentDuration * 60) + totalTravelSeconds;
            document.getElementById('total-time-info').textContent = `Totale tijd (afspraak + reistijd): ${formatDuration(totalDurationSeconds)}`;
            document.getElementById('diagnostic-panel').style.display = 'block';
        }

        async function handleTimeSlotClick(slot, btn) {
            if (btn.disabled) return;
            
            if (btn.classList.contains('active')) {
                btn.classList.remove('active');
                btn.className = 'btn btn-outline-success border-success';
                document.getElementById('booking-form').style.display = 'none';
                selectedSlot = null;
                return;
            }
            
            if (btn.classList.contains('btn-success')) {
                selectedSlot = slot;
                document.querySelectorAll('#time-picker .btn').forEach(b => {
                    if (b !== btn) b.classList.remove('active');
                });
                btn.className = 'btn btn-success active';
                document.getElementById('booking-form-title').innerHTML = `üìù Bevestig uw gegevens voor <strong>${appointmentTitle}</strong> bij <i>${creatorEmail}</i>`;
                document.getElementById('booking-form').style.display = 'block';
                return;
            }

            document.querySelectorAll('#time-picker .btn').forEach(b => b.classList.remove('active'));
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;
            document.getElementById('booking-form').style.display = 'none';
            
            try {
                const response = await fetch('/verify-slot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ linkId, destinationAddress, slotStart: slot.start }),
                });

                if (!response.ok) {
                    if(response.status === 429) {
                        showError('U heeft te veel verzoeken gedaan. Probeer het over 5 minuten opnieuw.');
                    } else {
                        throw new Error('Verificatie van het slot is mislukt.');
                    }
                    btn.className = 'btn btn-warning';
                    btn.innerHTML = 'Verificatie mislukt';
                    btn.disabled = false;
                    return;
                }
                
                const data = await response.json();
                updateDiagnostics(data.diagnostic);
                
                const dayKey = slot.start.split('T')[0];
                rippledDays.add(dayKey);
                slotsByDay.set(dayKey, data.updatedGapSlots);
                renderTimeSlots(dayKey);
                
                const clickedButton = Array.from(document.querySelectorAll('#time-picker .btn')).find(b => b.dataset.start === slot.start);
                if (clickedButton && data.isViable) {
                     selectedSlot = slot;
                     clickedButton.className = 'btn btn-success active';
                     document.getElementById('booking-form-title').innerHTML = `üìù Bevestig uw gegevens voor <strong>${appointmentTitle}</strong> bij <i>${creatorEmail}</i>`;
                     document.getElementById('booking-form').style.display = 'block';
                } else if (clickedButton) {
                    clickedButton.className = 'btn btn-danger';
                    clickedButton.disabled = true;
                }

            } catch (error) {
                console.error('Fout bij slot verificatie:', error);
                btn.className = 'btn btn-warning';
                btn.innerHTML = 'Verificatie mislukt';
                btn.disabled = false;
            }
        }

        function renderTimeSlots(dayKey) {
            const timePicker = document.getElementById('time-picker');
            timePicker.innerHTML = '';
            document.getElementById('booking-form').style.display = 'none';
            const times = slotsByDay.get(dayKey) || [];

            if (times.length > 0) {
                times.forEach(slot => {
                    const btn = document.createElement('button');
                    let btnClass = '';
                    if (rippledDays.has(dayKey)) {
                        btnClass = 'btn btn-outline-success border-success';
                    } else {
                        const marginInfo = certaintyInfo[slot.marginCategory] || certaintyInfo.red;
                        btnClass = `btn ${marginInfo.class} ${marginInfo.borderClass}`;
                    }
                    btn.className = btnClass;
                    btn.textContent = new Date(slot.start).toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
                    btn.dataset.start = slot.start;
                    btn.dataset.margin = slot.marginCategory;
                    btn.onclick = () => handleTimeSlotClick(slot, btn);
                    timePicker.appendChild(btn);
                });
            } else {
                timePicker.innerHTML = '<p class="text-center text-muted">Geen tijden beschikbaar op deze dag.</p>';
            }
        }

        function handleDayClick(dayKey, dayButton) {
            document.querySelectorAll('#day-picker .btn').forEach(b => b.classList.remove('active'));
            dayButton.classList.add('active');
            renderTimeSlots(dayKey);
        }

        function renderDayPicker(availableDays, initialSlots) {
            const dayPicker = document.getElementById('day-picker');
            dayPicker.innerHTML = '';
            slotsByDay = groupSlotsByDay(initialSlots);
            rippledDays.clear();

            availableDays.forEach(dayKey => {
                const btn = document.createElement('button');
                const hasSlots = slotsByDay.has(dayKey) && slotsByDay.get(dayKey).length > 0;
                btn.className = `btn day-btn ${hasSlots ? 'btn-outline-primary' : 'btn-outline-secondary'}`;
                const date = new Date(dayKey + 'T12:00:00Z');
                btn.textContent = date.toLocaleDateString('nl-NL', { timeZone: 'UTC', weekday: 'long', day: 'numeric', month: 'long' });
                btn.dataset.dayKey = dayKey;
                if (!hasSlots) btn.disabled = true;
                btn.onclick = () => handleDayClick(dayKey, btn);
                dayPicker.appendChild(btn);
            });

            const firstDayWithSlots = availableDays.find(dayKey => slotsByDay.has(dayKey) && slotsByDay.get(dayKey).length > 0);
            if (firstDayWithSlots) {
                const firstDayButton = dayPicker.querySelector(`[data-day-key="${firstDayWithSlots}"]`);
                if (firstDayButton) firstDayButton.click();
            } else {
                document.getElementById('time-picker').innerHTML = '<p class="text-center text-muted">Er zijn geen beschikbare dagen in deze periode.</p>';
            }
        }

        function groupSlotsByDay(rawSlots) {
            const grouped = new Map();
            rawSlots.forEach(slot => {
                const dayKey = slot.start.split('T')[0];
                if (!grouped.has(dayKey)) grouped.set(dayKey, []);
                grouped.get(dayKey).push(slot);
            });
            return grouped;
        }

        document.getElementById('check-availability-btn').addEventListener('click', async () => {
            destinationAddress = document.getElementById('destinationAddress').value;
            if (!destinationAddress) {
                alert('Voer een adres in.');
                return;
            }
            switchView('loading-view');
            try {
                const response = await fetch(`/get-availability?linkId=${linkId}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Kon beschikbaarheid niet ophalen: ${errorText}`);
                }

                const data = await response.json();
                appointmentDuration = data.duration;
                creatorEmail = data.creatorEmail;
                appointmentTitle = data.title;
                document.getElementById('appointment-title-booking').textContent = `üóìÔ∏è ${data.title}`;
                document.getElementById('appointment-description').textContent = data.description;
                
                renderDayPicker(data.availableDays, data.initialSlots);
                switchView('booking-view');
                displayLegend();

            } catch (error) {
                showError(error.message);
            }
        });

        document.getElementById('booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;

            try {
                const comments = document.getElementById('comments').value;
                const response = await fetch('/book-appointment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ linkId, startTime: selectedSlot.start, name, email, destinationAddress, phone, comments }),
                });
                if (!response.ok) throw new Error('Kon de afspraak niet boeken.');
                switchView('confirmation-view');
            } catch (error) {
                showError(error.message);
            }
        });

        async function initMap() {
            try {
                const { Autocomplete } = await google.maps.importLibrary('places');
                const input = document.getElementById('destinationAddress');
                new Autocomplete(input, { types: ['address'], componentRestrictions: { country: 'nl' } });
            } catch (e) {
                console.error("Could not load Google Maps Autocomplete", e);
            }
        }

        async function loadGoogleMapsScript() {
            if (!linkId) return showError('Ongeldige of ontbrekende link-ID.');
            try {
                const response = await fetch('/api/config');
                if (!response.ok) throw new Error('Kon configuratie niet laden.');
                const config = await response.json();
                if (!config.mapsApiKey) return;

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${config.mapsApiKey}&libraries=places&callback=initMap&loading=async`;
                script.async = true;
                document.head.appendChild(script);
            } catch (error) {
                console.error('Error loading Google Maps:', error);
            }
        }

        window.initMap = initMap;
        document.addEventListener('DOMContentLoaded', loadGoogleMapsScript);
    </script>
</body>
</html>